#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""M.O.L.O.C.H. PTZ Controller Module - Thread-safe PTZ-Steuerung"""

import time
import logging
import threading
from typing import Optional
from dataclasses import dataclass
from datetime import datetime

logger = logging.getLogger(__name__)


@dataclass
class PTZAction:
    timestamp: float
    action: str
    pan: float = 0.0
    tilt: float = 0.0
    duration: float = 0.0
    success: bool = False
    error: str = ""
    
    def to_log(self) -> str:
        ts = datetime.fromtimestamp(self.timestamp).strftime("%H:%M:%S")
        status = "OK" if self.success else f"FAIL:{self.error}"
        return f"[PTZ {ts}] {self.action} pan={self.pan:+.2f} tilt={self.tilt:+.2f} dur={self.duration:.2f}s {status}"


class PTZController:
    MAX_VELOCITY = 1.0
    MAX_DURATION = 2.0
    DEFAULT_DURATION = 0.3
    
    def __init__(self, host="192.168.178.25", port=80, user="Moloch_4.5", password="Auge666"):
        self.host = host
        self.port = port
        self.user = user
        self.password = password
        self._camera = None
        self._ptz = None
        self._token = None
        self._lock = threading.Lock()
        self._is_moving = False
        self.connected = False
        self._history = []
        logger.info(f"PTZController init (host={host})")
    
    def connect(self) -> bool:
        with self._lock:
            if self.connected:
                return True
            try:
                from onvif import ONVIFCamera
                self._camera = ONVIFCamera(self.host, self.port, self.user, self.password)
                self._ptz = self._camera.create_ptz_service()
                media = self._camera.create_media_service()
                self._token = media.GetProfiles()[0].token
                self.connected = True
                logger.info(f"PTZ connected (token={self._token})")
                return True
            except Exception as e:
                logger.error(f"PTZ connect failed: {e}")
                return False
    
    def move(self, pan: float, tilt: float, duration: float = None) -> PTZAction:
        if duration is None:
            duration = self.DEFAULT_DURATION
        pan = max(-1, min(1, pan))
        tilt = max(-1, min(1, tilt))
        duration = max(0.01, min(self.MAX_DURATION, duration))
        
        action = PTZAction(time.time(), "move", pan, tilt, duration)
        
        with self._lock:
            if not self.connected:
                action.error = "not_connected"
                logger.warning(action.to_log())
                return action
            if self._is_moving:
                action.error = "busy"
                return action
            try:
                self._is_moving = True
                req = self._ptz.create_type("ContinuousMove")
                req.ProfileToken = self._token
                req.Velocity = {"PanTilt": {"x": pan, "y": tilt}}
                self._ptz.ContinuousMove(req)
                time.sleep(duration)
                self._stop_internal()
                action.success = True
                self._history.append(action)
            except Exception as e:
                action.error = str(e)
            finally:
                self._is_moving = False
        logger.info(action.to_log())
        return action
    
    def stop(self) -> PTZAction:
        action = PTZAction(time.time(), "stop")
        with self._lock:
            if not self.connected:
                action.error = "not_connected"
                return action
            try:
                self._stop_internal()
                action.success = True
                self._is_moving = False
            except Exception as e:
                action.error = str(e)
        logger.info(action.to_log())
        return action
    
    def center(self) -> PTZAction:
        """Move camera to home/center position."""
        action = PTZAction(time.time(), "center")
        with self._lock:
            if not self.connected:
                action.error = "not_connected"
                return action
            try:
                req = self._ptz.create_type("GotoHomePosition")
                req.ProfileToken = self._token
                self._ptz.GotoHomePosition(req)
                action.success = True
            except Exception as e:
                action.error = str(e)
                logger.warning(f"GotoHome not supported: {e}")
        logger.info(action.to_log())
        return action
    
    def _stop_internal(self):
        req = self._ptz.create_type("Stop")
        req.ProfileToken = self._token
        req.PanTilt = True
        req.Zoom = True
        self._ptz.Stop(req)
    
    def is_moving(self) -> bool:
        with self._lock:
            return self._is_moving
    
    def get_history(self, limit=10) -> list:
        return self._history[-limit:]


_ctrl = None

def get_ptz_controller() -> PTZController:
    global _ctrl
    if _ctrl is None:
        _ctrl = PTZController()
    return _ctrl
